drop table bopis;
drop table bopis_orders;
drop table bopis_days;

/*bopis orders*/
create table bopis_orders as
select
ecom.indiv_id,
ecom.order_id,
tm.day_dt,
tm2.day_dt as pick_up_date,
tm2.wk_idnt
from ua_ecom_order_dtl ecom
inner join bopis bps on substr(bps.order_id, 0, 10) = substr(ecom.order_id, 4, 10)
inner join ua_pos_tm_day tm on to_date(ecom.dmnd_dt) = (tm.day_dt)
inner join ua_pos_tm_day tm2 on bps.pickup_date = tm2.day_dt
where bps.PICKUP_DATE_TIME !='Canceled';

select * from bopis_orders where rownum <77

select 
*
from bopis bps
inner join ua_pos_tm_day tm on bps.pickup_date = tm.day_dt

select * from ua_pos_tm_day where rownum <55



/*get date range for orders*/
select
min(day_dt),
max(day_dt)
from bopis_orders

drop table bopis_days;
/*bopis days*/
create table bopis_days as
select
ecom.indiv_id,
min(tm.day_dt) as first_purchase
from ua_ecom_order_dtl ecom
inner join bopis bps on substr(bps.order_id, 0, 10) = substr(ecom.order_id, 4, 10)
inner join ua_pos_tm_day tm on to_date(ecom.dmnd_dt) = (tm.day_dt)
group by ecom.indiv_id;

/*overall numbers*/
select
count(distinct ecom.indiv_id )                                           as customers,
count(distinct ecom.order_id)                                            as orders,
sum(ecom.flfll_net_ttl_amt)                                               as bopis_sales,
sum(ecom.flfll_unit_cnt)                                                      as bopis_units
from ua_ecom_order_dtl ecom
where order_id in (select order_id from bopis_orders bps inner join bopis_days days on days. indiv_id = bps.indiv_id where days.last_purchase < '20-APR-18');

/*30 days prior to bopis order
update  bps.first_purchase date to have a 30 day window of sales after
*/
select
count(distinct coalesce(stre.indiv_id, ecom.indiv_id))                                                    as customers, 
sum((coalesce(stre.store_trans, 0)) +  coalesce(ecom.ecom_trans, 0))                     as trans,
sum((coalesce(stre.store_sales, 0)) + coalesce(ecom.ecom_sales, 0))                      as sales,
sum((coalesce(stre.store_units, 0)) + coalesce(ecom.ecom_units, 0))                      as units
from (
select
        dtl.indiv_id, 
        count(distinct dtl.pos_trans_key) as store_trans,
        sum(dtl.extended_sls_amt) as store_sales,
        sum(dtl.grs_mrgn_amt) as store_gm,
        sum(dtl.qty) as store_units
        from ua_pos_trans_dtl dtl 
        inner join ua_store str on dtl.loc_key = str.loc_key
        inner join bopis_days bps on dtl.indiv_id = bps.indiv_id and bps.first_purchase < '20-APR-18'
        inner join ua_pos_tm_day tm on dtl.day_idnt = tm.day_idnt
        where tm.day_dt between bps.first_purchase-31 and bps.first_purchase-1 and dtl.trans_typ_key in (19,22,33) and str.distt_idnt !='999'
        group by dtl.indiv_id) stre
full outer join (
        select
        ecom.indiv_id,
        count(distinct ecom.order_id) as  ecom_trans,
        sum(ecom.flfll_net_ttl_amt) as ecom_sales,
        sum(ecom.flfll_unit_cnt) as ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        inner join bopis_days bps on ecom.indiv_id = bps.indiv_id and bps.first_purchase <'20-APR-18'
        where tm.day_dt between bps.first_purchase-31 and bps.first_purchase-1
        group by ecom.indiv_id) ecom on stre.indiv_id = ecom.indiv_id;

/*30 days after bopis order
update  bps.first_purchase date to have a 30 day window of sales after
*/
select
count(distinct coalesce(stre.indiv_id, ecom.indiv_id))                                                    as customers, 
sum((coalesce(stre.store_trans, 0)) +  coalesce(ecom.ecom_trans, 0))                     as trans,
sum((coalesce(stre.store_sales, 0)) + coalesce(ecom.ecom_sales, 0))                      as sales,
sum((coalesce(stre.store_units, 0)) + coalesce(ecom.ecom_units, 0))                      as units
from (
select
        dtl.indiv_id, 
        count(distinct dtl.pos_trans_key) as store_trans,
        sum(dtl.extended_sls_amt) as store_sales,
        sum(dtl.grs_mrgn_amt) as store_gm,
        sum(dtl.qty) as store_units
        from ua_pos_trans_dtl dtl 
        inner join ua_store str on dtl.loc_key = str.loc_key
        inner join bopis_days bps on dtl.indiv_id = bps.indiv_id and bps.first_purchase < '20-APR-18'
        inner join ua_pos_tm_day tm on dtl.day_idnt = tm.day_idnt
        where tm.day_dt between bps.first_purchase+3 and bps.first_purchase+33 and dtl.trans_typ_key in (19,22,33) and str.distt_idnt !='999'
        group by dtl.indiv_id) stre
full outer join (
        select
        ecom.indiv_id,
        count(distinct ecom.order_id) as  ecom_trans,
        sum(ecom.flfll_net_ttl_amt) as ecom_sales,
        sum(ecom.flfll_unit_cnt) as ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        inner join bopis_days bps on ecom.indiv_id = bps.indiv_id and bps.first_purchase < '20-APR-18'
        where tm.day_dt between  bps.first_purchase+3 and bps.first_purchase+33 
        group by ecom.indiv_id) ecom on stre.indiv_id = ecom.indiv_id;

/*one year prior*/
select
count(distinct coalesce(stre.indiv_id, ecom.indiv_id))                                                    as customers, 
sum((coalesce(stre.store_trans, 0)) +  coalesce(ecom.ecom_trans, 0))                     as trans,
sum((coalesce(stre.store_sales, 0)) + coalesce(ecom.ecom_sales, 0))                      as sales,
sum((coalesce(stre.store_units, 0)) + coalesce(ecom.ecom_units, 0))                      as units
from (
select
        dtl.indiv_id, 
        count(distinct dtl.pos_trans_key) as store_trans,
        sum(dtl.extended_sls_amt) as store_sales,
        sum(dtl.grs_mrgn_amt) as store_gm,
        sum(dtl.qty) as store_units
        from ua_pos_trans_dtl dtl 
        inner join ua_store str on dtl.loc_key = str.loc_key
        inner join bopis_days bps on dtl.indiv_id = bps.indiv_id and bps.first_purchase <  '20-APR-18'
        inner join ua_pos_tm_day tm on dtl.day_idnt = tm.day_idnt
        where tm.day_dt between bps.first_purchase-365 -31 and bps.first_purchase-365 -1 and dtl.trans_typ_key in (19,22,33) and str.distt_idnt !='999'
        group by dtl.indiv_id) stre
full outer join (
        select
        ecom.indiv_id,
        count(distinct ecom.order_id) as  ecom_trans,
        sum(ecom.flfll_net_ttl_amt) as ecom_sales,
        sum(ecom.flfll_unit_cnt) as ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        inner join bopis_days bps on ecom.indiv_id = bps.indiv_id and bps.first_purchase <  '20-APR-18'
        where tm.day_dt between bps.first_purchase-365 -31 and bps.first_purchase-365 -1
        group by ecom.indiv_id) ecom on stre.indiv_id = ecom.indiv_id;

 /*one year prior*/
select
count(distinct coalesce(stre.indiv_id, ecom.indiv_id))                                                    as customers, 
sum((coalesce(stre.store_trans, 0)) +  coalesce(ecom.ecom_trans, 0))                     as trans,
sum((coalesce(stre.store_sales, 0)) + coalesce(ecom.ecom_sales, 0))                      as sales,
sum((coalesce(stre.store_units, 0)) + coalesce(ecom.ecom_units, 0))                      as units
from (
select
        dtl.indiv_id, 
        count(distinct dtl.pos_trans_key) as store_trans,
        sum(dtl.extended_sls_amt) as store_sales,
        sum(dtl.grs_mrgn_amt) as store_gm,
        sum(dtl.qty) as store_units
        from ua_pos_trans_dtl dtl 
        inner join ua_store str on dtl.loc_key = str.loc_key
        inner join bopis_days bps on dtl.indiv_id = bps.indiv_id and bps.first_purchase <  '20-APR-18'
        inner join ua_pos_tm_day tm on dtl.day_idnt = tm.day_idnt
        where tm.day_dt between bps.first_purchase-365 +3 and bps.first_purchase-365 +33 and dtl.trans_typ_key in (19,22,33) and str.distt_idnt !='999'
        group by dtl.indiv_id) stre
full outer join (
        select
        ecom.indiv_id,
        count(distinct ecom.order_id) as  ecom_trans,
        sum(ecom.flfll_net_ttl_amt) as ecom_sales,
        sum(ecom.flfll_unit_cnt) as ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        inner join bopis_days bps on ecom.indiv_id = bps.indiv_id and bps.first_purchase <  '20-APR-18'
        where tm.day_dt between  bps.first_purchase-365 +3 and bps.first_purchase-365 +33 
        group by ecom.indiv_id) ecom on stre.indiv_id = ecom.indiv_id;


DEFINE start_wk_idnt = '201712';
DEFINE end_wk_idnt = '201716';

DEFINE start_wk_idnt = '201812';
DEFINE end_wk_idnt = '201816';
/* weekly customer numbers */
select
coalesce(stre.wk_idnt, ecom.wk_idnt)                                                                                                                                                                                                           as wk_idnt,
count(distinct coalesce(stre.indiv_id, ecom.indiv_id))                                                                                                                                                                            as customers,
count(distinct stre.indiv_id)                                                                                                                                                                                                                                as store_customers,
count(distinct ecom.indiv_id)                                                                                                                                                                                                                             as ecom_customers,
sum(store_sales)                                                                                                                                                                                                                                                      as store_sales,
sum(ecom_sales)                                                                                                                                                                                                                                                      as ecom_sales,
sum(store_trans)                                                                                                                                                                                                                                                       as store_trans,
sum(ecom_trans)                                                                                                                                                                                                                                                       as ecom_trans
from (select
          dtl.wk_idnt,
          dtl.indiv_id,
          count(distinct dtl.pos_trans_key)                       as store_trans,
          sum(dtl.extended_sls_amt)                                  as store_sales,
          sum(dtl.grs_mrgn_amt)                                           as store_gm,
          sum(dtl.qty)                                                                 as store_units
         from         ua_pos_trans_dtl dtl
         inner join ua_store str on dtl.loc_key = str.loc_key
         where dtl.wk_idnt between &start_wk_idnt and &end_wk_idnt and dtl.trans_typ_key in(19,22,33) and str.distt_idnt != '999'
        group by dtl.indiv_id, dtl.wk_idnt) stre
    full outer join(
    select
        tm.wk_idnt,
        ecom.indiv_id,
        count(distinct ecom.order_id)                           as ecom_trans,
        sum(ecom.flfll_net_ttl_amt)                             as ecom_sales,
        sum(ecom.flfll_unit_cnt)                                as ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        where tm.wk_idnt between &start_wk_idnt and &end_wk_idnt
        and ecom.order_id   in (select order_id from bopis_orders)
        /*change to "not in" to look at non-bopis orders*/
        group by ecom.indiv_id, tm.wk_idnt) ecom on stre.indiv_id = ecom.indiv_id and stre.wk_idnt = ecom.wk_idnt
        group by coalesce(stre.wk_idnt, ecom.wk_idnt)
        order by  coalesce(stre.wk_idnt, ecom.wk_idnt) asc ;
 /* overall customer numbers */       
select
count(distinct coalesce(stre.indiv_id, ecom.indiv_id))                                                                                                                                                                                     as customers,
count(distinct stre.indiv_id)                                                                                                                                                                                                                                         as store_customers,
count(distinct ecom.indiv_id)                                                                                                                                                                                                                                     as ecom_customers,
sum(store_trans)                                                                                                                                                                                                                                                              as store_trans,
sum(ecom_trans)                                                                                                                                                                                                                                                              as ecom_trans,
sum(store_sales)                                                                                                                                                                                                                                                              as store_sales,
sum(ecom_sales)                                                                                                                                                                                                                                                              as ecom_sales
from (select
          dtl.indiv_id,
          count(distinct dtl.pos_trans_key)                       as store_trans,
          sum(dtl.extended_sls_amt)                                  as store_sales,
          sum(dtl.grs_mrgn_amt)                                           as store_gm,
          sum(dtl.qty)                                                                  as store_units
         from         ua_pos_trans_dtl dtl
         inner join ua_store str on dtl.loc_key = str.loc_key
         where dtl.wk_idnt between &start_wk_idnt and &end_wk_idnt and dtl.trans_typ_key in(19,22,33) and str.distt_idnt != '999'
        group by dtl.indiv_id) stre
    full outer join(
    select
        ecom.indiv_id,
        count(distinct ecom.order_id)                             as ecom_trans,
        sum(ecom.flfll_net_ttl_amt)                                as ecom_sales,
        sum(ecom.flfll_unit_cnt)                                       as ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        where tm.wk_idnt between &start_wk_idnt and &end_wk_idnt
        and ecom.order_id  not  in (select order_id from bopis_orders)
        group by ecom.indiv_id) ecom on stre.indiv_id = ecom.indiv_id ;
        
        
/*weekly bopis numbers*/
select
count(distinct ecom.indiv_id )                                            as customers,
count(distinct ecom.order_id)                                            as orders,
sum(ecom.flfll_net_ttl_amt)                                               as bopis_sales,
sum(ecom.flfll_unit_cnt)                                                      as bopis_units
from ua_ecom_order_dtl ecom
inner join ua_pos_tm_day tm on to_date(ecom.dmnd_dt) = (tm.day_dt)
where order_id in (select order_id from bopis_orders bps  )
and tm.wk_idnt between &start_wk_idnt and &end_wk_idnt;

select
count(distinct ecom.indiv_id )                                            as customers,
count(distinct ecom.order_id)                                            as orders,
sum(ecom.flfll_net_ttl_amt)                                               as bopis_sales,
sum(ecom.flfll_unit_cnt)                                                      as bopis_units
from ua_ecom_order_dtl ecom
inner join ua_pos_tm_day tm on to_date(ecom.dmnd_dt) = (tm.day_dt)
where order_id in (select ord.order_id from bopis_orders ord inner join bopis_days bps on ord.indiv_id = bps.indiv_id  and bps.first_purchase = ord.day_dt and bps.first_purchase < '20-APR-18');


/*basket analysis*/
select 
sku.grp_desc,
count(distinct ecom.indiv_id )                                            as customers,
count(distinct ecom.order_id)                                            as orders,
sum(ecom.flfll_net_ttl_amt)                                               as bopis_sales,
sum(ecom.flfll_unit_cnt)                                                      as bopis_units
from ua_ecom_order_dtl ecom
inner join ua_pos_prod_sku sku on ecom.sku_name=sku.sku_idnt
where ecom.order_id in (select order_id from bopis_orders where wk_idnt between &start_wk_idnt and &end_wk_idnt)
group by sku.grp_desc
order by bopis_sales desc;

select 
sku.sku_desc,
count(distinct ecom.indiv_id )                                            as customers,
count(distinct ecom.order_id)                                            as orders,
sum(ecom.flfll_net_ttl_amt)                                               as bopis_sales,
sum(ecom.flfll_unit_cnt)                                                      as bopis_units
from ua_ecom_order_dtl ecom
inner join ua_pos_prod_sku sku on ecom.sku_name=sku.sku_idnt
where ecom.order_id in (select order_id from bopis_orders where wk_idnt between 201812 and 201813)
group by sku.sku_desc
order by bopis_units desc;

select 
count(distinct ecom.indiv_id )                                            as customers,
count(distinct ecom.order_id)                                            as orders,
sum(ecom.flfll_net_ttl_amt)                                               as bopis_sales,
sum(ecom.flfll_unit_cnt)                                                      as bopis_units
from ua_ecom_order_dtl ecom
inner join ua_pos_prod_sku sku on ecom.sku_name=sku.sku_idnt
where ecom.order_id in (select order_id from bopis_orders)
--and ecom.order_id in (select ecom.order_id from ua_ecom_order_dtl ecom inner join ua_pos_prod_sku sku on ecom.sku_name = sku.sku_idnt inner join bopis_orders bps on bps.order_id = ecom.order_id and sku.class_desc = '644 KEY ITEM WALL FRAMES');

set define off;
/*overall basket*/
select 
count(distinct ecom.indiv_id )                                            as customers,
count(distinct ecom.order_id)                                            as orders,
sum(ecom.flfll_net_ttl_amt)                                               as bopis_sales,
sum(ecom.flfll_unit_cnt)                                                      as bopis_units
from ua_ecom_order_dtl ecom
inner join ua_pos_prod_sku sku on ecom.sku_name=sku.sku_idnt
where ecom.order_id in (select order_id from bopis_orders)
and ecom.order_id in (select ecom.order_id from ua_ecom_order_dtl ecom inner join ua_pos_prod_sku sku on ecom.sku_name = sku.sku_idnt inner join bopis_orders bps on bps.order_id = ecom.order_id and sku.class_desc = '644 KEY ITEM WALL FRAMES');

select
count(distinct dtl.indiv_id )                                                  as customers,
count(distinct dtl.pos_trans_key)                                      as trans,
sum(dtl.extended_sls_amt)                                                 as sales,
sum(dtl.qty)                                                                                as units
from         ua_pos_trans_dtl dtl
inner join ua_store str on dtl.loc_key = str.loc_key and str.distt_idnt != '999'
inner join ua_pos_prod_sku sku on dtl.sku_key=sku.sku_key
where dtl.wk_idnt between 201734 and 201813 
and dtl.trans_typ_key in(19,22,33);

select
sku.class_desc,
count(distinct dtl.indiv_id )                                                  as customers,
count(distinct dtl.pos_trans_key)                                      as trans,
sum(dtl.extended_sls_amt)                                                 as sales,
sum(dtl.qty)                                                                                as units
from         ua_pos_trans_dtl dtl
inner join ua_store str on dtl.loc_key = str.loc_key and str.distt_idnt != '999'
inner join ua_pos_prod_sku sku on dtl.sku_key=sku.sku_key
where dtl.wk_idnt between 201734 and 201813 
and dtl.trans_typ_key in(19,22,33) 
and sku.class_desc in ( '081 CRICUT', '061 CANVAS & SURFACES', '945 DISPLAY CASES', '001 CRAFT STORAGE', '644 KEY ITEM WALL FRAMES')
group by sku.class_desc;
set define off

select
--sku.class_desc,
count(distinct dtl.indiv_id )                                                  as customers,
count(distinct dtl.pos_trans_key)                                      as trans,
sum(dtl.extended_sls_amt)                                                 as sales,
sum(dtl.qty)                                                                                as units
from         ua_pos_trans_dtl dtl
inner join ua_store str on dtl.loc_key = str.loc_key and str.distt_idnt != '999'
inner join ua_pos_prod_sku sku on dtl.sku_key=sku.sku_key
where dtl.wk_idnt between 201634 and 201713 
and dtl.trans_typ_key in(19,22,33) 
--and sku.class_desc in ( '081 CRICUT', '061 CANVAS & SURFACES', '945 DISPLAY CASES', '001 CRAFT STORAGE', '644 KEY ITEM WALL FRAMES')
--group by sku.class_desc;

select
sku.class_desc,
count(distinct dtl.indiv_id )                                                  as customers,
count(distinct dtl.pos_trans_key)                                      as trans,
sum(dtl.extended_sls_amt)                                                 as sales,
sum(dtl.qty)                                                                                as units
from         ua_pos_trans_dtl dtl
inner join ua_store str on dtl.loc_key = str.loc_key and str.distt_idnt != '999'
inner join ua_pos_prod_sku sku on dtl.sku_key=sku.sku_key
where dtl.wk_idnt between 201734 and 201813 
and dtl.trans_typ_key in(19,22,33) 
and dtl.pos_trans_key in (
      select 
      dtl.pos_trans_key 
      from ua_pos_trans_dtl dtl 
      inner join ua_store str on dtl.loc_key = str.loc_key and str.distt_idnt != '999' 
      inner join ua_pos_prod_sku sku on dtl.sku_key = sku.sku_key 
      where dtl.wk_idnt between 201734 and 201813 
      and sku.class_desc in ( '061 CANVAS & SURFACES'))
group by sku.class_desc
order by sales desc;

/*customer group data*/
-------this year metrics-------
DEFINE start_day_idnt = '2018078';
DEFINE end_day_idnt = '2018112';
DEFINE start_wk_idnt = '201812';
DEFINE end_wk_idnt = '201816';
DEFINE mth = 'bps';

create table start_wk_&mth as
select &end_wk_idnt as end_wk_idnt,
wk_idnt as start_wk_idnt ,
day_idnt as start_day_idnt
from ua_pos_tm_day
where day_dt = 
(
select day_dt - 357
from
(select max(day_dt) as day_dt
from ua_pos_tm_day where wk_idnt = &end_wk_idnt)
);

create table rolling12trans_&mth as
select
coalesce(stre.indiv_id, ecom.indiv_id)                                                                                                                                                                                                                 as indiv_id,
sum((coalesce(stre.rolling12store_sales,0))+ (coalesce(ecom.rolling12ecom_sales, 0)))                                                                                                               as total_sales,
sum((coalesce(stre.rolling12store_trans,0))+ (coalesce(ecom.rolling12ecom_trans, 0)))                                                                                                               as total_trans,
sum((coalesce(stre.rolling12store_units,0))+ (coalesce(ecom.rolling12ecom_units, 0)))                                                                                                               as total_units,
sum(stre.rolling12store_gm)                                                                                                                                                                                                                                       as gm_store,
sum(stre.rolling12store_sales)                                                                                                                                                                                                                                   as sales_store,
(case when stre.indiv_id= ecom.indiv_id then 'omni' when stre.indiv_id >0 then 'store only' when ecom.indiv_id >0 then 'ecom only' end)         as channel
from (select
          dtl.indiv_id,
          count(distinct dtl.pos_trans_key)                       as rolling12store_trans,
          sum(dtl.extended_sls_amt)                               as rolling12store_sales,
          sum(dtl.grs_mrgn_amt)                                   as rolling12store_gm,
          sum(dtl.qty)                                            as rolling12store_units
         from         ua_pos_trans_dtl dtl
         inner join ua_store str on dtl.loc_key = str.loc_key
         where dtl.wk_idnt between (select start_wk_idnt from start_wk_&mth) and &end_wk_idnt and dtl.trans_typ_key in(19,22,33) and str.distt_idnt != '999'
         and dtl. indiv_id in (select indiv_id from bopis_orders where wk_idnt between 201812 and 201813)
        group by dtl.indiv_id) stre
    full outer join(
    select
        ecom.indiv_id,
        count(distinct ecom.order_id)                           as rolling12ecom_trans,
        sum(ecom.flfll_net_ttl_amt)                             as rolling12ecom_sales,
        sum(ecom.flfll_unit_cnt)                                as rolling12ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        where tm.wk_idnt between (select start_wk_idnt from start_wk_&mth) and &end_wk_idnt
        and ecom. indiv_id in (select indiv_id from bopis_orders where wk_idnt between 201812 and 201813)
        group by ecom.indiv_id) ecom on stre.indiv_id = ecom.indiv_id
group by stre.indiv_id, ecom.indiv_id;

#NAME?
create table timeframe_&mth as
select
(case when stre.indiv_id= ecom.indiv_id then stre.indiv_id else coalesce(stre.indiv_id, ecom.indiv_id) end)                                     as indiv_id,
sum((coalesce(stre.store_trans,0))+ (coalesce(ecom.ecom_trans, 0)))                                                                                                                   as timeframe_trans,
sum((coalesce(stre.store_sales,0))+ (coalesce(ecom.ecom_sales, 0)))                                                                                                                   as timeframe_sales,
sum((coalesce(stre.store_units,0))+ (coalesce(ecom.ecom_units, 0)))                                                                                                                   as timeframe_units,
sum(stre.store_gm)                                                                                                                                                                                                                         as store_gm,
sum(stre.store_sales)                                                                                                                                                                                                                   as store_sales,
(case when stre.indiv_id= ecom.indiv_id then 'omni' when stre.indiv_id >0 then 'store only' when ecom.indiv_id >0 then 'ecom only' end)         as channel
from (select
          dtl.indiv_id,
          count(distinct dtl.pos_trans_key)                       as store_trans,
          sum(dtl.extended_sls_amt)                               as store_sales,
          sum(dtl.grs_mrgn_amt)                                   as store_gm,
          sum(dtl.qty)                                            as store_units
         from         ua_pos_trans_dtl dtl
         inner join ua_store str on dtl.loc_key = str.loc_key
         where dtl.wk_idnt between &start_wk_idnt and &end_wk_idnt and dtl.trans_typ_key in(19,22,33) and str.distt_idnt != '999'
         and dtl. indiv_id in (select indiv_id from bopis_orders where wk_idnt between 201812 and 201813)
        group by dtl.indiv_id) stre
    full outer join(
    select
        ecom.indiv_id,
        count(distinct ecom.order_id)                           as ecom_trans,
        sum(ecom.flfll_net_ttl_amt)                             as ecom_sales,
        sum(ecom.flfll_unit_cnt)                                as ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        where tm.wk_idnt between &start_wk_idnt and &end_wk_idnt
        and ecom. indiv_id in (select indiv_id from bopis_orders where wk_idnt between 201812 and 201813)
        group by ecom.indiv_id) ecom on stre.indiv_id = ecom.indiv_id
group by stre.indiv_id, ecom.indiv_id;

create table last_shop_excl_&mth as
select
       dtl.indiv_id,
       max(dtl.day_idnt) as last_shop
    from ua_pos_trans_dtl dtl inner join ua_store str on dtl.loc_key = str.loc_key
    inner join timeframe_&mth mth on dtl.indiv_id = mth.indiv_id
    where dtl.wk_idnt < &start_wk_idnt and dtl.trans_typ_key in(19,22,33) group by dtl.indiv_id;

create table new_cust_&mth as
  select            
  distinct (indiv_id)     
  from timeframe_&mth
  where indiv_id not in (select distinct indiv_id from last_shop_excl_&mth);

create table react_cust_&mth as
    select distinct(indiv_id)
    from timeframe_&mth
    where indiv_id in (select distinct indiv_id from last_shop_excl_&mth where last_shop <= (select start_day_idnt from start_wk_&mth));

create table new_react_cust_&mth as
    select distinct indiv_id
    from new_cust_&mth
    union
    select distinct indiv_id
    from react_cust_&mth;

#NAME?
create table cust_groups_&mth as
    select
       case when new_react.indiv_id is not null               then 'new'
            when rolling.total_trans >= 6                                   then 'top'
            when rolling.total_trans >= 3                                   then 'middle'
            when rolling.total_trans >= 1                                    then 'bottom'
                                                          else 'z.error'
       end                                                as custgroup,
       rolling.indiv_id
      from        rolling12trans_&mth rolling
      left join new_react_cust_&mth new_react             on rolling.indiv_id = new_react.indiv_id;

select
count(distinct cust.indiv_id),
cust.custgroup
from cust_groups_&mth  cust
--inner join bopis_orders bps on bps.indiv_id = cust.indiv_id
--where indiv_id  in (select indiv_id from bopis_orders)
group by cust.custgroup


drop table bopis_orders;
create table bopis_orders as
select
bps.order_id as bps_order_id,
ecom.indiv_id,
ecom.order_id,
tm.day_dt
from bopis bps 
left join ua_ecom_order_dtl ecom on substr(bps.order_id, 0, 10) = substr(ecom.order_id, 4, 10)
left join ua_pos_tm_day tm on to_date(ecom.dmnd_dt) = (tm.day_dt);

select
* 
from bopis_orders bps
inner join bopis bopis on bopis.order_id = bps.bps_order_id
where bps.order_id is null

select 
ecom.order_id as ecom_order,
bps.order_id as bps_order
from ua_ecom_order_dtl ecom
full outer join bopis bps on substr(bps.order_id, 0, 10) < substr(ecom.order_id, 4, 10)
left join ua_pos_tm_day tm on (tm.day_dt) =  to_date(ecom.dmnd_dt) 
where tm.wk_idnt = 201812
and ecom.order_id in (select order_id from bopis_orders)
and ecom.order_id is null
order by bps.order_id


select
count(distinct ecom.order_id) as orders
from ua_ecom_order_dtl ecom
inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
where ecom.order_id in (select order_id from bopis_orders)
and tm.wk_idnt = 201812

select 
count(distinct bps.order_id)
from bopis bps
where bps.order_day between '22-APR-18' and '28-APR-18'
and bps.email_address  not like 'LUE%'
44428


inner join ua_pos_tm_day tm on to_date(ecom.dmnd_dt) = (tm.day_dt)

DEFINE end_wk_idnt = '201812';

select
count(distinct ecom.indiv_id )                                            as customers,
count(distinct ecom.order_id)                                            as orders,
sum(ecom.flfll_net_ttl_amt)                                               as bopis_sales,
sum(ecom.flfll_unit_cnt)                                                      as bopis_units
from ua_ecom_order_dtl ecom
inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
where order_id in (select order_id from bopis_orders)
and tm.wk_idnt = 201812;

select
count(distinct bps.order_id) as orders
from bopis bps
where bps.TBL_DATE_TABLE_FISCALWEEK = 12
and PICKUP_DATE !='Canceled'
44,428
41,230


TBL_DATE_TABLE_FISCALWEEK

select * from bopis where rownum <88


select 
distinct
bps.email_address,
count(distinct bps.order_id) as orders,
email.email_addr_txt
from bopis bps
left join ua_email email on email.email_addr_txt =upper(bps.email_address)
where bps.order_day between '29-APR-18' and '05-MAY-18'
and email_addr_txt is null
group by bps.email_address, email.email_addr_txt


select
count(distinct coalesce (stre.indiv_id, ecom.indiv_id))                                                                                                                                                       as customers,
sum( (coalesce(stre.store_trans,0))+ (coalesce(ecom.ecom_trans, 0)) )                                                                                                                    as trans,
sum( (coalesce(stre.store_sales,0))+ (coalesce(ecom.ecom_sales, 0)) )                                                                                                                    as sales,
sum( (coalesce(stre.store_units,0))+ (coalesce(ecom.ecom_units, 0)) )                                                                                                                    as units
from (select
          dtl.indiv_id,
          count(distinct dtl.pos_trans_key)                       as store_trans,
          sum(dtl.extended_sls_amt)                               as store_sales,
          sum(dtl.grs_mrgn_amt)                                   as store_gm,
          sum(dtl.qty)                                            as store_units
         from         ua_pos_trans_dtl dtl
         inner join ua_store str on dtl.loc_key = str.loc_key
         where dtl.wk_idnt between 201812 and 201813 and dtl.trans_typ_key in(19,22,33) and str.distt_idnt != '999'
         and dtl.indiv_id in (select indiv_id from bopis_orders)
        group by dtl.indiv_id) stre
    full outer join(
    select
        ecom.indiv_id,
        count(distinct ecom.order_id)                           as ecom_trans,
        sum(ecom.flfll_net_ttl_amt)                             as ecom_sales,
        sum(ecom.flfll_unit_cnt)                                as ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        where tm.wk_idnt between 201801 and 201812 
         and ecom.indiv_id in (select indiv_id from bopis_orders)
         and ecom.order_id not in (select order_id from bopis_orders)
        group by ecom.indiv_id) ecom on stre.indiv_id = ecom.indiv_id;

select
count(distinct  dtl.indiv_id)                                        as store_customers,
count(distinct dtl.pos_trans_key)                            as store_trans,
sum(dtl.extended_sls_amt)                                      as store_sales,
sum(dtl.qty)                                                                     as store_units
from ua_pos_trans_dtl dtl 
inner join ua_store str on dtl.loc_key = str.loc_key and str.distt_idnt!='999'
inner join ua_pos_tm_day tm on dtl.day_idnt = tm.day_idnt
where dtl.wk_idnt between 201812 and 201816
and dtl.indiv_id||(tm.day_dt) in (
        select ecom.indiv_id||bps.pick_up_date
        from ua_ecom_order_dtl ecom
        inner join bopis_orders bps on ecom.indiv_id = bps.indiv_id  
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = tm.day_dt 
        where tm.wk_idnt between 201812 and 201816 )
and dtl.indiv_id||(tm.day_dt)||dtl.extended_sls_amt not in (
        select ecom.indiv_id||bps.pick_up_date||ecom.FLFLL_NET_TTL_AMT 
        from ua_ecom_order_dtl ecom 
        inner join bopis_orders bps on bps.indiv_id =ecom.indiv_id  
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = tm.day_dt 
        where tm.wk_idnt between 201812 and 201816);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
select 
sku.sku_desc,
count(distinct ecom.indiv_id )                                            as customers,
count(distinct ecom.order_id)                                            as orders,
sum(ecom.flfll_net_ttl_amt)                                               as bopis_sales,
sum(ecom.flfll_unit_cnt)                                                      as bopis_units
from ua_ecom_order_dtl ecom
inner join ua_pos_prod_sku sku on ecom.sku_name=sku.sku_idnt
where ecom.order_id in (select order_id from bopis_orders where wk_idnt between 201812 and 201815)
group by sku.sku_desc
order by bopis_units desc
