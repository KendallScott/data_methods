
select 
sku.grp_desc,
count(distinct ecom.indiv_id )                                            as customers,
count(distinct ecom.order_id)                                            as orders,
sum(ecom.flfll_net_ttl_amt)                                               as bopis_sales,
sum(ecom.flfll_unit_cnt)                                                      as bopis_units
from ua_ecom_order_dtl ecom
inner join bopis bps on substr(bps.order_id, 3, 10) = substr(ecom.order_id, 4, 10)
#NAME?
left join ua_pos_prod_sku sku on ecom.sku_name=sku.sku_idnt
--and dtl.indiv_id||(dtl.day_idnt) in (select ecom.indiv_id||tm.day_idnt from ua_ecom_order_dtl ecom inner join bopis bps on ecom.email = bps.email_addr_txt inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = tm.day_dt )
--and dtl.indiv_id||(dtl.day_idnt)||dtl.extended_sls_amt not in (select ecom.indiv_id||tm.day_idnt||ecom.FLFLL_NET_TTL_AMT from ua_ecom_order_dtl ecom inner join bopis bps on ecom.email = bps.email_addr_txt inner join ua_pos_tm_day tm on to_date(ecom.flfl
group by sku.grp_desc
order by bopis_sales desc

select 
*
from ua_ecom_order_dtl where rownum <55


select 
sku.sku_desc,
count(distinct ecom.indiv_id )                                            as customers,
count(distinct ecom.order_id)                                            as orders,
sum(ecom.flfll_net_ttl_amt)                                               as bopis_sales,
sum(ecom.flfll_unit_cnt)                                                      as bopis_units
from ua_ecom_order_dtl ecom
inner join bopis bps on substr(bps.order_id, 3, 10) = substr(ecom.order_id, 4, 10)
#NAME?
left join ua_pos_prod_sku sku on ecom.sku_name=sku.sku_idnt
--and dtl.indiv_id||(dtl.day_idnt) in (select ecom.indiv_id||tm.day_idnt from ua_ecom_order_dtl ecom inner join bopis bps on ecom.email = bps.email_addr_txt inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = tm.day_dt )
--and dtl.indiv_id||(dtl.day_idnt)||dtl.extended_sls_amt not in (select ecom.indiv_id||tm.day_idnt||ecom.FLFLL_NET_TTL_AMT from ua_ecom_order_dtl ecom inner join bopis bps on ecom.email = bps.email_addr_txt inner join ua_pos_tm_day tm on to_date(ecom.flfl
group by sku.sku_desc
order by bopis_sales desc

select * from ua_pos_prod_sku where rownum <55



select 
sku.grp_desc,
count(distinct ecom.indiv_id )                                            as customers,
count(distinct ecom.order_id)                                            as orders,
sum(ecom.flfll_net_ttl_amt)                                               as bopis_sales,
sum(ecom.flfll_unit_cnt)                                                      as bopis_units
from ua_ecom_order_dtl ecom
inner join bopis bps on substr(bps.order_id, 3, 10) = substr(ecom.order_id, 4, 10)
left join ua_pos_prod_sku sku on ecom.sku_name=sku.sku_idnt
--and dtl.indiv_id||(dtl.day_idnt) in (select ecom.indiv_id||tm.day_idnt from ua_ecom_order_dtl ecom inner join bopis bps on ecom.email = bps.email_addr_txt inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = tm.day_dt )
--and dtl.indiv_id||(dtl.day_idnt)||dtl.extended_sls_amt not in (select ecom.indiv_id||tm.day_idnt||ecom.FLFLL_NET_TTL_AMT from ua_ecom_order_dtl ecom inner join bopis bps on ecom.email = bps.email_addr_txt inner join ua_pos_tm_day tm on to_date(ecom.flfl
group by sku.grp_desc
order by bopis_sales desc

select 
count(distinct ecom.indiv_id )                                            as customers,
count(distinct ecom.order_id)                                            as orders,
sum(ecom.flfll_net_ttl_amt)                                               as bopis_sales,
sum(ecom.flfll_unit_cnt)                                                      as bopis_units
from ua_ecom_order_dtl ecom
inner join bopis bps on substr(bps.order_id, 3, 10) = substr(ecom.order_id, 4, 10)
#NAME?
left join ua_pos_prod_sku sku on ecom.sku_name=sku.sku_idnt
--and dtl.indiv_id||(dtl.day_idnt) in (select ecom.indiv_id||tm.day_idnt from ua_ecom_order_dtl ecom inner join bopis bps on ecom.email = bps.email_addr_txt inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = tm.day_dt )
--and dtl.indiv_id||(dtl.day_idnt)||dtl.extended_sls_amt not in (select ecom.indiv_id||tm.day_idnt||ecom.FLFLL_NET_TTL_AMT from ua_ecom_order_dtl ecom inner join bopis bps on ecom.email = bps.email_addr_txt inner join ua_pos_tm_day tm on to_date(ecom.flfl
order by bopis_sales desc

drop table bopis_orders

create table bopis_orders as
select
ecom.indiv_id,
ecom.order_id
from ua_ecom_order_dtl ecom
inner join bopis bps on substr(bps.order_id, 3, 10) = substr(ecom.order_id, 4, 10)

select
count(distinct ecom.indiv_id )                                            as customers,
count(distinct ecom.order_id)                                            as orders,
sum(ecom.flfll_net_ttl_amt)                                               as bopis_sales,
sum(ecom.flfll_unit_cnt)                                                      as bopis_units
from ua_ecom_order_dtl ecom
where order_id not in (select order_id from bopis_orders)
and indiv_id in (select indiv_id from bopis_orders)

select
count(distinct coalesce (stre.indiv_id, ecom.indiv_id))                                                                                                                                                       as customers,
sum( (coalesce(stre.store_trans,0))+ (coalesce(ecom.ecom_trans, 0)) )                                                                                                                    as trans,
sum( (coalesce(stre.store_sales,0))+ (coalesce(ecom.ecom_sales, 0)) )                                                                                                                    as sales,
sum( (coalesce(stre.store_units,0))+ (coalesce(ecom.ecom_units, 0)) )                                                                                                                    as units
from (select
          dtl.indiv_id,
          count(distinct dtl.pos_trans_key)                       as store_trans,
          sum(dtl.extended_sls_amt)                               as store_sales,
          sum(dtl.grs_mrgn_amt)                                   as store_gm,
          sum(dtl.qty)                                            as store_units
         from         ua_pos_trans_dtl dtl
         inner join ua_store str on dtl.loc_key = str.loc_key
         where dtl.wk_idnt between 201801 and 201812 and dtl.trans_typ_key in(19,22,33) and str.distt_idnt != '999'
         and dtl.indiv_id in (select indiv_id from bopis_orders)
        group by dtl.indiv_id) stre
    full outer join(
    select
        ecom.indiv_id,
        count(distinct ecom.order_id)                           as ecom_trans,
        sum(ecom.flfll_net_ttl_amt)                             as ecom_sales,
        sum(ecom.flfll_unit_cnt)                                as ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        where tm.wk_idnt between 201801 and 201812 
         and ecom.indiv_id in (select indiv_id from bopis_orders)
         and ecom.order_id not in (select order_id from bopis_orders)
        group by ecom.indiv_id) ecom on stre.indiv_id = ecom.indiv_id;
        
        set worksheetname agg_tables;
-------this year metrics-------
DEFINE start_day_idnt = '2018001';
DEFINE end_day_idnt = '2018080';
DEFINE start_wk_idnt = '201801';
DEFINE end_wk_idnt = '201812';
DEFINE mth = 'bps';

create table start_wk_&mth as
select &end_wk_idnt as end_wk_idnt,
wk_idnt as start_wk_idnt ,
day_idnt as start_day_idnt
from ua_pos_tm_day
where day_dt = 
(
select day_dt - 357
from
(select max(day_dt) as day_dt
from ua_pos_tm_day where wk_idnt = &end_wk_idnt)
);

create table all_indivs_24mo_&mth as
select
(case when stre.indiv_id= ecom.indiv_id then stre.indiv_id else coalesce(stre.indiv_id, ecom.indiv_id) end)                                     as indiv_id
from (select
          dtl.indiv_id
         from         ua_pos_trans_dtl dtl
         inner join ua_store str on dtl.loc_key = str.loc_key
         where dtl.wk_idnt between ( &end_wk_idnt - 200 + 1) and &end_wk_idnt and dtl.trans_typ_key in(19,22,33) and str.distt_idnt != '999'
        group by dtl.indiv_id) stre
    full outer join(
    select
        ecom.indiv_id
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        where tm.day_idnt between  (&end_day_idnt - 2000 + 1) and &end_day_idnt
        group by ecom.indiv_id) ecom on stre.indiv_id = ecom.indiv_id
group by stre.indiv_id, ecom.indiv_id;
drop table rolling12trans_&mth

#NAME?
create table rolling12trans_&mth as
select
coalesce(stre.indiv_id, ecom.indiv_id)                                                                                                                                                                                                                 as indiv_id,
sum((coalesce(stre.rolling12store_sales,0))+ (coalesce(ecom.rolling12ecom_sales, 0)))                                                                                                               as total_sales,
sum((coalesce(stre.rolling12store_trans,0))+ (coalesce(ecom.rolling12ecom_trans, 0)))                                                                                                               as total_trans,
sum((coalesce(stre.rolling12store_units,0))+ (coalesce(ecom.rolling12ecom_units, 0)))                                                                                                               as total_units,
sum(stre.rolling12store_gm)                                                                                                                                                                                                                                       as gm_store,
sum(stre.rolling12store_sales)                                                                                                                                                                                                                                   as sales_store,
(case when stre.indiv_id= ecom.indiv_id then 'omni' when stre.indiv_id >0 then 'store only' when ecom.indiv_id >0 then 'ecom only' end)         as channel
from (select
          dtl.indiv_id,
          count(distinct dtl.pos_trans_key)                       as rolling12store_trans,
          sum(dtl.extended_sls_amt)                               as rolling12store_sales,
          sum(dtl.grs_mrgn_amt)                                   as rolling12store_gm,
          sum(dtl.qty)                                            as rolling12store_units
         from         ua_pos_trans_dtl dtl
         inner join ua_store str on dtl.loc_key = str.loc_key
         where dtl.wk_idnt between (select start_wk_idnt from start_wk_&mth) and &end_wk_idnt and dtl.trans_typ_key in(19,22,33) and str.distt_idnt != '999'
        group by dtl.indiv_id) stre
    full outer join(
    select
        ecom.indiv_id,
        count(distinct ecom.order_id)                           as rolling12ecom_trans,
        sum(ecom.flfll_net_ttl_amt)                             as rolling12ecom_sales,
        sum(ecom.flfll_unit_cnt)                                as rolling12ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        where tm.wk_idnt between (select start_wk_idnt from start_wk_&mth) and &end_wk_idnt
        group by ecom.indiv_id) ecom on stre.indiv_id = ecom.indiv_id
group by stre.indiv_id, ecom.indiv_id;

#NAME?
create table timeframe_&mth as
select
(case when stre.indiv_id= ecom.indiv_id then stre.indiv_id else coalesce(stre.indiv_id, ecom.indiv_id) end)                                     as indiv_id,
sum((coalesce(stre.store_trans,0))+ (coalesce(ecom.ecom_trans, 0)))                                                                                                                   as timeframe_trans,
sum((coalesce(stre.store_sales,0))+ (coalesce(ecom.ecom_sales, 0)))                                                                                                                   as timeframe_sales,
sum((coalesce(stre.store_units,0))+ (coalesce(ecom.ecom_units, 0)))                                                                                                                   as timeframe_units,
sum(stre.store_gm)                                                                                                                                                                                                                         as store_gm,
sum(stre.store_sales)                                                                                                                                                                                                                   as store_sales,
(case when stre.indiv_id= ecom.indiv_id then 'omni' when stre.indiv_id >0 then 'store only' when ecom.indiv_id >0 then 'ecom only' end)         as channel
from (select
          dtl.indiv_id,
          count(distinct dtl.pos_trans_key)                       as store_trans,
          sum(dtl.extended_sls_amt)                               as store_sales,
          sum(dtl.grs_mrgn_amt)                                   as store_gm,
          sum(dtl.qty)                                            as store_units
         from         ua_pos_trans_dtl dtl
         inner join ua_store str on dtl.loc_key = str.loc_key
         where dtl.wk_idnt between &start_wk_idnt and &end_wk_idnt and dtl.trans_typ_key in(19,22,33) and str.distt_idnt != '999'
        group by dtl.indiv_id) stre
    full outer join(
    select
        ecom.indiv_id,
        count(distinct ecom.order_id)                           as ecom_trans,
        sum(ecom.flfll_net_ttl_amt)                             as ecom_sales,
        sum(ecom.flfll_unit_cnt)                                as ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        where tm.wk_idnt between &start_wk_idnt and &end_wk_idnt
        group by ecom.indiv_id) ecom on stre.indiv_id = ecom.indiv_id
group by stre.indiv_id, ecom.indiv_id;

#NAME?
create table last_shop_excl_&mth as
select
       dtl.indiv_id,
       max(dtl.day_idnt) as last_shop
    from ua_pos_trans_dtl dtl inner join ua_store str on dtl.loc_key = str.loc_key
    inner join timeframe_&mth mth on dtl.indiv_id = mth.indiv_id
    where dtl.wk_idnt < &start_wk_idnt and dtl.trans_typ_key in(19,22,33) group by dtl.indiv_id;

#NAME?
create table new_cust_&mth as
  select            
  distinct (indiv_id)     
  from timeframe_&mth
  where indiv_id not in (select distinct indiv_id from last_shop_excl_&mth);

create table react_cust_&mth as
    select distinct(indiv_id)
    from timeframe_&mth
    where indiv_id in (select distinct indiv_id from last_shop_excl_&mth where last_shop <= (select start_day_idnt from start_wk_&mth));

create table new_react_cust_&mth as
    select distinct indiv_id
    from new_cust_&mth
    union
    select distinct indiv_id
    from react_cust_&mth;

#NAME?
create table cust_groups_&mth as
    select
       case when new_react.indiv_id is not null               then 'new'
            when rolling.total_trans >= 6                                   then 'top'
            when rolling.total_trans >= 3                                   then 'middle'
            when rolling.total_trans >= 1                                    then 'bottom'
                                                          else 'z.error'
       end                                                as custgroup,
       rolling.indiv_id
      from        rolling12trans_&mth rolling
      left join new_react_cust_&mth new_react             on rolling.indiv_id = new_react.indiv_id;

select
count(distinct cust.indiv_id),
cust.custgroup
from cust_groups_&mth  cust
--inner join bopis_orders bps on bps.indiv_id = cust.indiv_id
where indiv_id not in (select indiv_id from bopis_orders)
group by cust.custgroup

select * 
from ua_ecom_order_dtl ecom
inner join bopis bps on substr(bps.order_id, 3, 10) = substr(ecom.order_id, 4, 10)


select 
count(distinct ecom.indiv_id )                                            as customers,
ecom.order_id                                                                           as order_id,
sum(ecom.flfll_net_ttl_amt)                                               as bopis_sales,
sum(ecom.flfll_unit_cnt)                                                      as bopis_units
from ua_ecom_order_dtl ecom
inner join bopis bps on substr(bps.order_id, 3, 10) = substr(ecom.order_id, 4, 10)
inner join ua_pos_trans_dtl dtl on dtl.indiv_id = ecom.indiv_id
left join ua_pos_prod_sku sku on ecom.sku_name=sku.sku_idnt
and dtl.indiv_id||(dtl.day_idnt) in (select ecom.indiv_id||tm.day_idnt from ua_ecom_order_dtl ecom inner join bopis bps on ecom.email = bps.email_addr_txt inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = tm.day_dt )
and dtl.indiv_id||(dtl.day_idnt)||dtl.extended_sls_amt not in (select ecom.indiv_id||tm.day_idnt||ecom.FLFLL_NET_TTL_AMT from ua_ecom_order_dtl ecom inner join bopis bps on ecom.email = bps.email_addr_txt inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = tm.day_dt )

select
count(distinct coalesce(stre.indiv_id, ecom.indiv_id)) as customers, 
sum((coalesce(stre.store_trans, 0)) +  coalesce(ecom.ecom_trans, 0)) as trans,
sum((coalesce(stre.store_sales, 0)) + coalesce(ecom.ecom_sales, 0)) as sales,
sum((coalesce(stre.store_units, 0)) + coalesce(ecom.ecom_units, 0)) as units
from (
select
        dtl.indiv_id, 
        count(distinct dtl.pos_trans_key) as store_trans,
        sum(dtl.extended_sls_amt) as store_sales,
        sum(dtl.grs_mrgn_amt) as store_gm,
        sum(dtl.qty) as store_units
        from ua_pos_trans_dtl dtl 
        inner join ua_store str on dtl.loc_key = str.loc_key
        inner join bopis_days bps on dtl.indiv_id = bps.indiv_id and bps.first_purchase between 2018001 and 2018056
        where dtl.day_idnt between bps.first_purchase-31 and bps.first_purchase-1 and dtl.trans_typ_key in (19,22,33) and str.distt_idnt !='999'
        group by dtl.indiv_id) stre
full outer join (
        select
        ecom.indiv_id,
        count(distinct ecom.order_id) as  ecom_trans,
        sum(ecom.flfll_net_ttl_amt) as ecom_sales,
        sum(ecom.flfll_unit_cnt) as ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        inner join bopis_days bps on ecom.indiv_id = bps.indiv_id and bps.first_purchase between 2018001 and 2018056
        where tm.day_idnt between bps.first_purchase-31 and bps.first_purchase-1
        group by ecom.indiv_id) ecom on stre.indiv_id = ecom.indiv_id
        
select
count(distinct coalesce(stre.indiv_id, ecom.indiv_id)) as customers, 
sum((coalesce(stre.store_trans, 0)) +  coalesce(ecom.ecom_trans, 0)) as trans,
sum((coalesce(stre.store_sales, 0)) + coalesce(ecom.ecom_sales, 0)) as sales,
sum((coalesce(stre.store_units, 0)) + coalesce(ecom.ecom_units, 0)) as units
from (
select
        dtl.indiv_id, 
        count(distinct dtl.pos_trans_key) as store_trans,
        sum(dtl.extended_sls_amt) as store_sales,
        sum(dtl.grs_mrgn_amt) as store_gm,
        sum(dtl.qty) as store_units
        from ua_pos_trans_dtl dtl 
        inner join ua_store str on dtl.loc_key = str.loc_key
        inner join bopis_days bps on dtl.indiv_id = bps.indiv_id and bps.first_purchase between 2018001 and 2018056
        where dtl.day_idnt between bps.first_purchase+2 and bps.first_purchase+32 and dtl.trans_typ_key in (19,22,33) and str.distt_idnt !='999' 
        group by dtl.indiv_id) stre
full outer join (
        select
        ecom.indiv_id,
        count(distinct ecom.order_id) as  ecom_trans,
        sum(ecom.flfll_net_ttl_amt) as ecom_sales,
        sum(ecom.flfll_unit_cnt) as ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        inner join bopis_days bps on ecom.indiv_id = bps.indiv_id and bps.first_purchase between 2018001 and 2018056
        where tm.day_idnt between bps.first_purchase+2  and bps.first_purchase+32
        group by ecom.indiv_id) ecom on stre.indiv_id = ecom.indiv_id
        
select
count(distinct coalesce(stre.indiv_id, ecom.indiv_id)) as customers, 
sum((coalesce(stre.store_trans, 0)) +  coalesce(ecom.ecom_trans, 0)) as trans,
sum((coalesce(stre.store_sales, 0)) + coalesce(ecom.ecom_sales, 0)) as sales,
sum((coalesce(stre.store_units, 0)) + coalesce(ecom.ecom_units, 0)) as units
from (
select
        dtl.indiv_id, 
        count(distinct dtl.pos_trans_key) as store_trans,
        sum(dtl.extended_sls_amt) as store_sales,
        sum(dtl.grs_mrgn_amt) as store_gm,
        sum(dtl.qty) as store_units
        from ua_pos_trans_dtl dtl 
        inner join ua_store str on dtl.loc_key = str.loc_key
        inner join bopis_days bps on dtl.indiv_id = bps.indiv_id and bps.first_purchase between 2018001 and 2018056
        where dtl.day_idnt between bps.first_purchase-100-31 and bps.first_purchase-100-1  and dtl.trans_typ_key in (19,22,33) and str.distt_idnt !='999'
        group by dtl.indiv_id) stre
full outer join (
        select
        ecom.indiv_id,
        count(distinct ecom.order_id) as  ecom_trans,
        sum(ecom.flfll_net_ttl_amt) as ecom_sales,
        sum(ecom.flfll_unit_cnt) as ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        inner join bopis_days bps on ecom.indiv_id = bps.indiv_id and bps.first_purchase between 2018001 and 2018056
        where tm.day_idnt between bps.first_purchase-100-31 and bps.first_purchase-100-1 
        group by ecom.indiv_id) ecom on stre.indiv_id = ecom.indiv_id
        
select
count(distinct coalesce(stre.indiv_id, ecom.indiv_id)) as customers, 
sum((coalesce(stre.store_trans, 0)) +  coalesce(ecom.ecom_trans, 0)) as trans,
sum((coalesce(stre.store_sales, 0)) + coalesce(ecom.ecom_sales, 0)) as sales,
sum((coalesce(stre.store_units, 0)) + coalesce(ecom.ecom_units, 0)) as units
from (
select
        dtl.indiv_id, 
        count(distinct dtl.pos_trans_key) as store_trans,
        sum(dtl.extended_sls_amt) as store_sales,
        sum(dtl.grs_mrgn_amt) as store_gm,
        sum(dtl.qty) as store_units
        from ua_pos_trans_dtl dtl 
        inner join ua_store str on dtl.loc_key = str.loc_key
        inner join bopis_days bps on dtl.indiv_id = bps.indiv_id
        where dtl.day_idnt between bps.first_purchase-100+1  and bps.first_purchase-100+31 and dtl.trans_typ_key in (19,22,33) and str.distt_idnt !='999'
        group by dtl.indiv_id) stre
full outer join (
        select
        ecom.indiv_id,
        count(distinct ecom.order_id) as  ecom_trans,
        sum(ecom.flfll_net_ttl_amt) as ecom_sales,
        sum(ecom.flfll_unit_cnt) as ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        inner join bopis_days bps on ecom.indiv_id = bps.indiv_id
        where tm.day_idnt between bps.first_purchase-100+1  and bps.first_purchase-100+31
        group by ecom.indiv_id) ecom on stre.indiv_id = ecom.indiv_id        
        
  select 
count(distinct order_id)
from unica.ua_ecom_order_dtl 
where carrierid = 'Ship To Store' or carrierservicelevel = 'Ship To Store'
--and order_id not in (select order_id from bopis)

select 
count(distinct order_id) as orders,
carrierservicelevel
from ua_ecom_order_dtl
where invoicedatetime between '02-APR-18' and '24-APR-18'
and line_item_type = 'DEMAND'
and order_id in (select order_id from bopis_orders)
group by carrierservicelevel
order by orders desc

SELECT
count(distinct ecom.order_id) as orders,
carrierservicelevel
FROM ua_ecom_order_dtl ecom
inner join bopis_orders bps on bps.order_id=ecom.order_id
group by carrierservicelevel
order by orders desc

create table bopis_orders as
select 
ecom.order_id,
indiv_id
from ua_ecom_order_dtl ecom
inner join bopis bps on substr(bps.order_id, 0, 10) = substr(ecom.order_id, 4, 10)


select
substr(bps.order_id, 4, 10) ,
substr(bps.order_id, 3, 10) ,
substr(bps.order_id, 2, 10) 
from bopis bps

select 
ecom.gsi_store_id,
count(distinct ecom.order_id)
from ua_ecom_order_dtl ecom
inner join bopis_orders bps on bps.order_id=ecom.order_id
group by ecom.gsi_store_id
83699

select * 
from ua_ecom_order_dtl ecom
inner join bopis_orders bps on bps.order_id=ecom.order_id
where rownum <100

SELECT 
count(distinct order_id)
FROM ua_ecom_order_dtl 
where gsi_store_id = 9290
drop table bopis_orders

order_id in (select order_id from bopis_orders)

SELECT 
count(distinct order_id)
FROM ua_ecom_order_dtl 
where oms_id = 'ISPU'
and invoicedatetime between '04-FEB-18' and '24-APR-18'
137561

select  from bopis

119,894

select * from ua_ecom_order_dtl

select * from bopis_orders where rownum <55
drop table bopis

select 
sku.grp_desc,
count(distinct ecom.indiv_id )                                            as customers,
count(distinct ecom.order_id)                                            as orders,
sum(ecom.flfll_net_ttl_amt)                                               as bopis_sales,
sum(ecom.flfll_unit_cnt)                                                      as bopis_units
from ua_ecom_order_dtl ecom
inner join bopis bps on substr(bps.order_id, 3, 10) = substr(ecom.order_id, 4, 10)
#NAME?
left join ua_pos_prod_sku sku on ecom.sku_name=sku.sku_idnt
--and dtl.indiv_id||(dtl.day_idnt) in (select ecom.indiv_id||tm.day_idnt from ua_ecom_order_dtl ecom inner join bopis bps on ecom.email = bps.email_addr_txt inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = tm.day_dt )
--and dtl.indiv_id||(dtl.day_idnt)||dtl.extended_sls_amt not in (select ecom.indiv_id||tm.day_idnt||ecom.FLFLL_NET_TTL_AMT from ua_ecom_order_dtl ecom inner join bopis bps on ecom.email = bps.email_addr_txt inner join ua_pos_tm_day tm on to_date(ecom.flfl
group by sku.grp_desc
order by bopis_sales desc

select 
*
from ua_ecom_order_dtl where rownum <55


select 
sku.sku_desc,
count(distinct ecom.indiv_id )                                            as customers,
count(distinct ecom.order_id)                                            as orders,
sum(ecom.flfll_net_ttl_amt)                                               as bopis_sales,
sum(ecom.flfll_unit_cnt)                                                      as bopis_units
from ua_ecom_order_dtl ecom
inner join bopis bps on substr(bps.order_id, 3, 10) = substr(ecom.order_id, 4, 10)
#NAME?
left join ua_pos_prod_sku sku on ecom.sku_name=sku.sku_idnt
--and dtl.indiv_id||(dtl.day_idnt) in (select ecom.indiv_id||tm.day_idnt from ua_ecom_order_dtl ecom inner join bopis bps on ecom.email = bps.email_addr_txt inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = tm.day_dt )
--and dtl.indiv_id||(dtl.day_idnt)||dtl.extended_sls_amt not in (select ecom.indiv_id||tm.day_idnt||ecom.FLFLL_NET_TTL_AMT from ua_ecom_order_dtl ecom inner join bopis bps on ecom.email = bps.email_addr_txt inner join ua_pos_tm_day tm on to_date(ecom.flfl
group by sku.sku_desc
order by bopis_sales desc

select * from ua_pos_prod_sku where rownum <55



select 
sku.grp_desc,
count(distinct ecom.indiv_id )                                            as customers,
count(distinct ecom.order_id)                                            as orders,
sum(ecom.flfll_net_ttl_amt)                                               as bopis_sales,
sum(ecom.flfll_unit_cnt)                                                      as bopis_units
from ua_ecom_order_dtl ecom
inner join bopis bps on substr(bps.order_id, 3, 10) = substr(ecom.order_id, 4, 10)
left join ua_pos_prod_sku sku on ecom.sku_name=sku.sku_idnt
--and dtl.indiv_id||(dtl.day_idnt) in (select ecom.indiv_id||tm.day_idnt from ua_ecom_order_dtl ecom inner join bopis bps on ecom.email = bps.email_addr_txt inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = tm.day_dt )
--and dtl.indiv_id||(dtl.day_idnt)||dtl.extended_sls_amt not in (select ecom.indiv_id||tm.day_idnt||ecom.FLFLL_NET_TTL_AMT from ua_ecom_order_dtl ecom inner join bopis bps on ecom.email = bps.email_addr_txt inner join ua_pos_tm_day tm on to_date(ecom.flfl
group by sku.grp_desc
order by bopis_sales desc

select 
count(distinct ecom.indiv_id )                                            as customers,
count(distinct ecom.order_id)                                            as orders,
sum(ecom.flfll_net_ttl_amt)                                               as bopis_sales,
sum(ecom.flfll_unit_cnt)                                                      as bopis_units
from ua_ecom_order_dtl ecom
inner join bopis bps on substr(bps.order_id, 3, 10) = substr(ecom.order_id, 4, 10)
#NAME?
left join ua_pos_prod_sku sku on ecom.sku_name=sku.sku_idnt
--and dtl.indiv_id||(dtl.day_idnt) in (select ecom.indiv_id||tm.day_idnt from ua_ecom_order_dtl ecom inner join bopis bps on ecom.email = bps.email_addr_txt inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = tm.day_dt )
--and dtl.indiv_id||(dtl.day_idnt)||dtl.extended_sls_amt not in (select ecom.indiv_id||tm.day_idnt||ecom.FLFLL_NET_TTL_AMT from ua_ecom_order_dtl ecom inner join bopis bps on ecom.email = bps.email_addr_txt inner join ua_pos_tm_day tm on to_date(ecom.flfl
order by bopis_sales desc

drop table bopis_orders;
drop table bopis_days;

create table bopis_orders as
select
ecom.indiv_id,
ecom.order_id,
tm.day_idnt
from ua_ecom_order_dtl ecom
inner join bopis bps on substr(bps.order_id, 0, 10) = substr(ecom.order_id, 4, 10)
inner join ua_pos_tm_day tm on to_date(ecom.dmnd_dt) = (tm.day_dt);

create table bopis_days as
select
ecom.indiv_id,
min(tm.day_dt) as first_purchase
from ua_ecom_order_dtl ecom
inner join bopis bps on substr(bps.order_id, 0, 10) = substr(ecom.order_id, 4, 10)
inner join ua_pos_tm_day tm on to_date(ecom.dmnd_dt) = (tm.day_dt)
group by ecom.indiv_id;

select * from  bopis_days where rownum <55


select
count(distinct ecom.indiv_id )                                            as customers,
count(distinct ecom.order_id)                                            as orders,
sum(ecom.flfll_net_ttl_amt)                                               as bopis_sales,
sum(ecom.flfll_unit_cnt)                                                      as bopis_units
from ua_ecom_order_dtl ecom
where order_id in (select order_id from bopis_orders)

select
count(distinct coalesce (stre.indiv_id, ecom.indiv_id))                                                                                                                                                    as customers,
sum( (coalesce(stre.store_trans,0))+ (coalesce(ecom.ecom_trans, 0)) )                                                                                                                    as trans,
sum( (coalesce(stre.store_sales,0))+ (coalesce(ecom.ecom_sales, 0)) )                                                                                                                    as sales,
sum( (coalesce(stre.store_units,0))+ (coalesce(ecom.ecom_units, 0)) )                                                                                                                    as units
from (select
          dtl.indiv_id,
          count(distinct dtl.pos_trans_key)                       as store_trans,
          sum(dtl.extended_sls_amt)                                  as store_sales,
          sum(dtl.grs_mrgn_amt)                                           as store_gm,
          sum(dtl.qty)                                                                  as store_units
         from         ua_pos_trans_dtl dtl
         inner join ua_store str on dtl.loc_key = str.loc_key
         inner join bopis_days bps on dtl.indiv_id = bps.indiv_id 
         where dtl.day_idnt between bps.first_purchase-31  and bps.first_purchase-1  and dtl.trans_typ_key in(19,22,33) and str.distt_idnt != '999'
        group by dtl.indiv_id) stre
    full outer join(
    select
        ecom.indiv_id,
        count(distinct ecom.order_id)                                as ecom_trans,
        sum(ecom.flfll_net_ttl_amt)                                   as ecom_sales,
        sum(ecom.flfll_unit_cnt)                                          as ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        inner join bopis_days bps on ecom.indiv_id = bps.indiv_id 
        where tm.day_idnt between bps.first_purchase-31  and bps.first_purchase-1
        group by ecom.indiv_id) ecom on stre.indiv_id = ecom.indiv_id;
        
  select
        ecom.indiv_id,
        count(distinct ecom.order_id)                                    as ecom_trans,
        sum(ecom.dmnd_net_ttl_amt)                                   as ecom_sales,
        sum(ecom.dmnd_unit_cnt)                                          as ecom_units
        from ua_ecom_order_dtl ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        inner join bopis_days bps on ecom.indiv_id = bps.indiv_id 
       and tm.day_idnt between bps.first_purchase-31 and bps.first_purchase-1
        group by ecom.indiv_id
        
        set worksheetname agg_tables;
-------this year metrics-------
DEFINE start_day_idnt = '2018001';
DEFINE end_day_idnt = '2018080';
DEFINE start_wk_idnt = '201801';
DEFINE end_wk_idnt = '201812';
DEFINE mth = 'bps';

create table start_wk_&mth as
select &end_wk_idnt as end_wk_idnt,
wk_idnt as start_wk_idnt ,
day_idnt as start_day_idnt
from ua_pos_tm_day
where day_dt = 
(
select day_dt - 357
from
(select max(day_dt) as day_dt
from ua_pos_tm_day where wk_idnt = &end_wk_idnt)
);

create table all_indivs_24mo_&mth as
select
(case when stre.indiv_id= ecom.indiv_id then stre.indiv_id else coalesce(stre.indiv_id, ecom.indiv_id) end)                                     as indiv_id
from (select
          dtl.indiv_id
         from         ua_pos_trans_dtl dtl
         inner join ua_store str on dtl.loc_key = str.loc_key
         where dtl.wk_idnt between ( &end_wk_idnt - 200 + 1) and &end_wk_idnt and dtl.trans_typ_key in(19,22,33) and str.distt_idnt != '999'
        group by dtl.indiv_id) stre
    full outer join(
    select
        ecom.indiv_id
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        where tm.day_idnt between  (&end_day_idnt - 2000 + 1) and &end_day_idnt
        group by ecom.indiv_id) ecom on stre.indiv_id = ecom.indiv_id
group by stre.indiv_id, ecom.indiv_id;
drop table rolling12trans_&mth

#NAME?
create table rolling12trans_&mth as
select
coalesce(stre.indiv_id, ecom.indiv_id)                                                                                                                                                                                                                 as indiv_id,
sum((coalesce(stre.rolling12store_sales,0))+ (coalesce(ecom.rolling12ecom_sales, 0)))                                                                                                               as total_sales,
sum((coalesce(stre.rolling12store_trans,0))+ (coalesce(ecom.rolling12ecom_trans, 0)))                                                                                                               as total_trans,
sum((coalesce(stre.rolling12store_units,0))+ (coalesce(ecom.rolling12ecom_units, 0)))                                                                                                               as total_units,
sum(stre.rolling12store_gm)                                                                                                                                                                                                                                       as gm_store,
sum(stre.rolling12store_sales)                                                                                                                                                                                                                                   as sales_store,
(case when stre.indiv_id= ecom.indiv_id then 'omni' when stre.indiv_id >0 then 'store only' when ecom.indiv_id >0 then 'ecom only' end)         as channel
from (select
          dtl.indiv_id,
          count(distinct dtl.pos_trans_key)                       as rolling12store_trans,
          sum(dtl.extended_sls_amt)                               as rolling12store_sales,
          sum(dtl.grs_mrgn_amt)                                   as rolling12store_gm,
          sum(dtl.qty)                                            as rolling12store_units
         from         ua_pos_trans_dtl dtl
         inner join ua_store str on dtl.loc_key = str.loc_key
         where dtl.wk_idnt between (select start_wk_idnt from start_wk_&mth) and &end_wk_idnt and dtl.trans_typ_key in(19,22,33) and str.distt_idnt != '999'
        group by dtl.indiv_id) stre
    full outer join(
    select
        ecom.indiv_id,
        count(distinct ecom.order_id)                           as rolling12ecom_trans,
        sum(ecom.flfll_net_ttl_amt)                             as rolling12ecom_sales,
        sum(ecom.flfll_unit_cnt)                                as rolling12ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        where tm.wk_idnt between (select start_wk_idnt from start_wk_&mth) and &end_wk_idnt
        group by ecom.indiv_id) ecom on stre.indiv_id = ecom.indiv_id
group by stre.indiv_id, ecom.indiv_id;

#NAME?
create table timeframe_&mth as
select
(case when stre.indiv_id= ecom.indiv_id then stre.indiv_id else coalesce(stre.indiv_id, ecom.indiv_id) end)                                     as indiv_id,
sum((coalesce(stre.store_trans,0))+ (coalesce(ecom.ecom_trans, 0)))                                                                                                                   as timeframe_trans,
sum((coalesce(stre.store_sales,0))+ (coalesce(ecom.ecom_sales, 0)))                                                                                                                   as timeframe_sales,
sum((coalesce(stre.store_units,0))+ (coalesce(ecom.ecom_units, 0)))                                                                                                                   as timeframe_units,
sum(stre.store_gm)                                                                                                                                                                                                                         as store_gm,
sum(stre.store_sales)                                                                                                                                                                                                                   as store_sales,
(case when stre.indiv_id= ecom.indiv_id then 'omni' when stre.indiv_id >0 then 'store only' when ecom.indiv_id >0 then 'ecom only' end)         as channel
from (select
          dtl.indiv_id,
          count(distinct dtl.pos_trans_key)                       as store_trans,
          sum(dtl.extended_sls_amt)                               as store_sales,
          sum(dtl.grs_mrgn_amt)                                   as store_gm,
          sum(dtl.qty)                                            as store_units
         from         ua_pos_trans_dtl dtl
         inner join ua_store str on dtl.loc_key = str.loc_key
         where dtl.wk_idnt between &start_wk_idnt and &end_wk_idnt and dtl.trans_typ_key in(19,22,33) and str.distt_idnt != '999'
        group by dtl.indiv_id) stre
    full outer join(
    select
        ecom.indiv_id,
        count(distinct ecom.order_id)                           as ecom_trans,
        sum(ecom.flfll_net_ttl_amt)                             as ecom_sales,
        sum(ecom.flfll_unit_cnt)                                as ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
        where tm.wk_idnt between &start_wk_idnt and &end_wk_idnt
        group by ecom.indiv_id) ecom on stre.indiv_id = ecom.indiv_id
group by stre.indiv_id, ecom.indiv_id;

#NAME?
create table last_shop_excl_&mth as
select
       dtl.indiv_id,
       max(dtl.day_idnt) as last_shop
    from ua_pos_trans_dtl dtl inner join ua_store str on dtl.loc_key = str.loc_key
    inner join timeframe_&mth mth on dtl.indiv_id = mth.indiv_id
    where dtl.wk_idnt < &start_wk_idnt and dtl.trans_typ_key in(19,22,33) group by dtl.indiv_id;

#NAME?
create table new_cust_&mth as
  select            
  distinct (indiv_id)     
  from timeframe_&mth
  where indiv_id not in (select distinct indiv_id from last_shop_excl_&mth);

create table react_cust_&mth as
    select distinct(indiv_id)
    from timeframe_&mth
    where indiv_id in (select distinct indiv_id from last_shop_excl_&mth where last_shop <= (select start_day_idnt from start_wk_&mth));

create table new_react_cust_&mth as
    select distinct indiv_id
    from new_cust_&mth
    union
    select distinct indiv_id
    from react_cust_&mth;

#NAME?
create table cust_groups_&mth as
    select
       case when new_react.indiv_id is not null               then 'new'
            when rolling.total_trans >= 6                                   then 'top'
            when rolling.total_trans >= 3                                   then 'middle'
            when rolling.total_trans >= 1                                    then 'bottom'
                                                          else 'z.error'
       end                                                as custgroup,
       rolling.indiv_id
      from        rolling12trans_&mth rolling
      left join new_react_cust_&mth new_react             on rolling.indiv_id = new_react.indiv_id;

select
count(distinct cust.indiv_id),
cust.custgroup
from cust_groups_&mth  cust
--inner join bopis_orders bps on bps.indiv_id = cust.indiv_id
where indiv_id not in (select indiv_id from bopis_orders)
group by cust.custgroup


      
